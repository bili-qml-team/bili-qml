name: Notify Tencent Pages Webhook on server changes

on:
    push:
        branches:
            - dev
        paths:
            - "src/server/**"

jobs:
    notify:
        name: Send webhook POST
        runs-on: ubuntu-latest
        steps:
            - name: Send webhook POST to EO Pages
              env:
                  WEBHOOK_URL: ${{ secrets.EO_PAGES_WEBHOOK }}
              run: |
                  set -e
                  echo "::add-mask::${WEBHOOK_URL}"

                  payload='{"ref":"'"$GITHUB_REF"'","repository":"'"$GITHUB_REPOSITORY"'","pusher":"'"$GITHUB_ACTOR"'"}'

                  status=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H "Content-Type: application/json" -d "$payload" "$WEBHOOK_URL")

                  if [ "$status" -ge 200 ] && [ "$status" -lt 300 ]; then
                    echo "Webhook POST succeeded (status $status)"
                  else
                    echo "Webhook POST failed with status $status"
                    exit 1
                  fi
